<!doctype html>
<html lang="en"><head><meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0c204a">
<title>Sky Core ‚Äî <span id="phaseTitle">Phase</span></title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Inter:wght@400;600;700&display=swap');

:root{
  --bg:#0a0e1a;
  --bg-elevated:#151b2e;
  --bg-card:#1a2238;
  --text:#e8edf5;
  --text-dim:#7d8ba3;
  --border:#252f45;
  --accent:#00d9ff;
  --accent-glow:rgba(0,217,255,0.3);
  --gold:#ffd700;
}

*{box-sizing:border-box;margin:0;padding:0}

body{
  background:var(--bg);
  color:var(--text);
  font-family:'Inter',system-ui,sans-serif;
  line-height:1.5;
  overflow-x:hidden;
  min-height:100vh;
}

body::before{
  content:'';
  position:fixed;
  top:0;left:0;right:0;bottom:0;
  background:radial-gradient(circle at 20% 30%, rgba(0,217,255,0.08) 0%, transparent 40%),
             radial-gradient(circle at 80% 70%, rgba(99,102,241,0.06) 0%, transparent 40%);
  pointer-events:none;
  z-index:0;
}

.wrap{
  max-width:640px;
  margin:0 auto;
  padding:20px 16px 40px;
  position:relative;
  z-index:1;
}

header{
  text-align:center;
  padding:24px 0 16px;
}

h1{
  font-family:'Rajdhani',sans-serif;
  font-size:32px;
  font-weight:700;
  letter-spacing:4px;
  text-transform:uppercase;
  background:linear-gradient(135deg, var(--accent) 0%, #6366f1 50%, var(--accent) 100%);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  margin-bottom:16px;
}

.player-info {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:12px;
  padding:0 8px;
}

.player-name {
  font-family:'Inter',sans-serif;
  font-size:13px;
  font-weight:600;
  color:var(--text-dim);
  text-transform:uppercase;
  letter-spacing:1px;
}

.phase-badge {
  font-family:'Rajdhani',sans-serif;
  font-size:12px;
  font-weight:700;
  text-transform:uppercase;
  letter-spacing:2px;
  color:var(--accent);
  padding:4px 12px;
  background:var(--bg-elevated);
  border:1px solid var(--border);
  border-radius:12px;
}

.controls-bar {
  display:flex;
  justify-content:center;
  gap:10px;
  flex-wrap:wrap;
  margin:16px 0;
}

.xp-row {
  display:flex;
  justify-content:center;
  align-items:center;
  gap:16px;
  margin:12px 0;
  flex-wrap:wrap;
}

#xp {
  font-family:'Rajdhani',sans-serif;
  font-size:16px;
  font-weight:700;
  text-transform:uppercase;
  letter-spacing:2px;
  color:var(--accent);
  padding:6px 16px;
  background:var(--bg-elevated);
  border:1px solid var(--border);
  border-radius:12px;
}

.row{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  align-items:center;
  justify-content:flex-start;
  margin-bottom:20px;
}

.card > .row input[type="checkbox"] {
  margin-right:16px;
}

.row label.row {
  margin-right:20px;
  padding:4px 8px;
  border-radius:8px;
  transition:background 0.2s;
}

.row label.row:hover {
  background:var(--bg-elevated);
}

.chip{
  background:var(--bg-card);
  border:2px solid var(--border);
  padding:10px 16px;
  border-radius:20px;
  font-family:'Rajdhani',sans-serif;
  font-size:13px;
  font-weight:700;
  text-transform:uppercase;
  letter-spacing:2px;
  color:var(--accent);
  transition:all 0.3s;
}

.chip:hover{
  border-color:var(--accent);
  box-shadow:0 4px 12px rgba(0,217,255,0.2);
}

.lynx{display:inline-flex;align-items:center;gap:6px}
.lynx:before{content:"üêæ"}

.badges{
  display:flex;
  gap:10px;
}

.badge{
  background:var(--bg-elevated);
  border:2px solid var(--border);
  padding:8px 16px;
  border-radius:24px;
  font-family:'Rajdhani',sans-serif;
  font-size:12px;
  font-weight:700;
  text-transform:uppercase;
  letter-spacing:2px;
  color:var(--text-dim);
  transition:all 0.3s;
}

.badge.earned{
  background:linear-gradient(135deg, var(--accent), #6366f1);
  border-color:var(--accent);
  color:var(--text);
  box-shadow:0 4px 16px var(--accent-glow);
  transform:scale(1.05);
}

input,select,button,textarea{
  background:var(--bg-card);
  border:1px solid #4a5f7f;
  color:var(--text);
  padding:12px 16px;
  border-radius:12px;
  font-size:14px;
  font-weight:700;
  font-family:'Rajdhani',sans-serif;
  text-transform:uppercase;
  letter-spacing:1px;
  transition:all 0.2s;
}

button{cursor:pointer}

button:hover,select:hover{
  background:var(--bg-elevated);
  border-color:var(--accent);
  transform:translateY(-1px);
  box-shadow:0 4px 12px rgba(0,217,255,0.2);
}

.card{
  background:var(--bg-card);
  border:2px solid var(--border);
  border-radius:20px;
  padding:24px;
  margin:16px 0;
  transition:all 0.3s;
  text-align:left;
}

.card:hover{
  border-color:var(--accent);
  box-shadow:0 8px 32px rgba(0,0,0,0.5);
}

.card strong{
  font-family:'Rajdhani',sans-serif;
  font-size:18px;
  font-weight:700;
  text-transform:uppercase;
  letter-spacing:3px;
  color:var(--accent);
  display:block;
  margin-bottom:16px;
  text-align:left;
}

.payoff-header {
  display:flex;
  align-items:center;
  justify-content:center;
  gap:12px;
  margin-bottom:20px;
  padding:12px 0;
}

.payoff-title {
  font-family:'Rajdhani',sans-serif;
  font-size:28px;
  font-weight:700;
  text-transform:uppercase;
  letter-spacing:5px;
  background:linear-gradient(135deg, var(--gold) 0%, #ffed4e 50%, var(--gold) 100%);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  text-shadow:0 0 30px rgba(255,215,0,0.5);
  display:inline-block;
  animation:glow-pulse 2s ease-in-out infinite;
  white-space:nowrap;
}

.payoff-icon {
  font-size:24px;
  display:inline-block;
  animation:icon-bounce 1s ease-in-out infinite;
  filter:drop-shadow(0 0 8px rgba(255,215,0,0.6));
}

@keyframes glow-pulse {
  0%, 100% { filter:brightness(1); }
  50% { filter:brightness(1.3); }
}

@keyframes icon-bounce {
  0%, 100% { transform:translateY(0); }
  50% { transform:translateY(-4px); }
}

.loading-screen {
  position:fixed;
  inset:0;
  background:var(--bg);
  z-index:9999;
  display:flex;
  align-items:center;
  justify-content:center;
  opacity:1;
  transition:opacity 0.5s ease;
}

.loading-screen.hidden {
  opacity:0;
  pointer-events:none;
}

.loading-content {
  text-align:center;
}

.loading-logo {
  margin-bottom:24px;
  animation:float 3s ease-in-out infinite;
}

.loading-circle {
  animation:spin 2s linear infinite, dash 1.5s ease-in-out infinite;
}

.loading-star {
  animation:pulse 2s ease-in-out infinite;
  transform-origin:center;
}

.loading-text {
  font-family:'Rajdhani',sans-serif;
  font-size:32px;
  font-weight:700;
  letter-spacing:4px;
  text-transform:uppercase;
  background:linear-gradient(135deg, var(--accent) 0%, #6366f1 50%, var(--accent) 100%);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  margin-bottom:8px;
}

.loading-subtext {
  font-family:'Rajdhani',sans-serif;
  font-size:14px;
  font-weight:600;
  color:var(--text-dim);
  text-transform:uppercase;
  letter-spacing:3px;
  animation:blink 1.5s ease-in-out infinite;
}

@keyframes float {
  0%, 100% { transform:translateY(0); }
  50% { transform:translateY(-10px); }
}

@keyframes spin {
  0% { transform:rotate(0deg); }
  100% { transform:rotate(360deg); }
}

@keyframes dash {
  0% { stroke-dashoffset:220; }
  50% { stroke-dashoffset:55; }
  100% { stroke-dashoffset:220; }
}

@keyframes pulse {
  0%, 100% { opacity:1; transform:scale(1); }
  50% { opacity:0.7; transform:scale(0.95); }
}

@keyframes blink {
  0%, 100% { opacity:1; }
  50% { opacity:0.5; }
}

/* Enhanced button hover effects */
button {
  position:relative;
  overflow:hidden;
}

button::before {
  content:'';
  position:absolute;
  top:50%;
  left:50%;
  width:0;
  height:0;
  border-radius:50%;
  background:rgba(0,217,255,0.3);
  transform:translate(-50%, -50%);
  transition:width 0.6s, height 0.6s;
}

button:active::before {
  width:300px;
  height:300px;
}

/* Smooth scroll behavior */
html {
  scroll-behavior:smooth;
}

/* Custom scrollbar styling */
::-webkit-scrollbar {
  width:10px;
  height:10px;
}

::-webkit-scrollbar-track {
  background:var(--bg-elevated);
  border-radius:10px;
}

::-webkit-scrollbar-thumb {
  background:linear-gradient(135deg, var(--accent), #6366f1);
  border-radius:10px;
  border:2px solid var(--bg-elevated);
}

::-webkit-scrollbar-thumb:hover {
  background:linear-gradient(135deg, #6366f1, var(--accent));
}

/* Custom text selection */
::selection {
  background:var(--accent);
  color:var(--bg);
}

::-moz-selection {
  background:var(--accent);
  color:var(--bg);
}

/* Better focus states for accessibility */
input:focus, select:focus, button:focus, textarea:focus {
  outline:2px solid var(--accent);
  outline-offset:2px;
}

/* Improved card animations */
.card {
  animation:fadeInUp 0.5s ease-out;
}

@keyframes fadeInUp {
  from {
    opacity:0;
    transform:translateY(20px);
  }
  to {
    opacity:1;
    transform:translateY(0);
  }
}

/* Enhanced progress bar animation */
.progress-fill {
  background:linear-gradient(90deg, var(--accent), #6366f1, var(--accent));
  background-size:200% 100%;
  animation:shimmer 3s linear infinite;
  box-shadow:0 0 20px var(--accent-glow);
}

@keyframes shimmer {
  0% { background-position:200% 0; }
  100% { background-position:-200% 0; }
}

/* Checkbox enhancement */
input[type="checkbox"] {
  appearance:none;
  width:20px;
  height:20px;
  border:3px solid var(--accent);
  border-radius:4px;
  background:var(--bg-card);
  cursor:pointer;
  position:relative;
  transition:all 0.3s;
  box-shadow:0 0 8px rgba(0,217,255,0.4);
}

input[type="checkbox"]:checked {
  background:linear-gradient(135deg, var(--accent), #6366f1);
  border-color:var(--accent);
  box-shadow:0 0 16px var(--accent-glow), 0 0 4px var(--accent);
}

input[type="checkbox"]:checked::after {
  content:'‚úì';
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%, -50%);
  color:var(--text);
  font-size:14px;
  font-weight:bold;
}

input[type="checkbox"]:hover {
  border-color:var(--accent);
  transform:scale(1.1);
  box-shadow:0 0 16px var(--accent-glow), 0 0 8px var(--accent);
}

/* Badge enhancement with glow effect */
.badge.earned {
  animation:badge-earned 0.6s ease-out;
}

@keyframes badge-earned {
  0% { transform:scale(0) rotate(-180deg); }
  50% { transform:scale(1.2) rotate(10deg); }
  100% { transform:scale(1.05) rotate(0deg); }
}

/* Toast notification system */
.toast-container {
  position:fixed;
  top:20px;
  right:20px;
  z-index:10000;
  display:flex;
  flex-direction:column;
  gap:10px;
  pointer-events:none;
}

.toast {
  background:var(--bg-card);
  border:2px solid var(--accent);
  border-radius:12px;
  padding:16px 20px;
  min-width:280px;
  box-shadow:0 8px 32px rgba(0,0,0,0.5), 0 0 20px var(--accent-glow);
  animation:slideInRight 0.3s ease-out;
  pointer-events:auto;
  display:flex;
  align-items:center;
  gap:12px;
}

.toast.success {
  border-color:var(--accent);
}

.toast.xp-gained {
  border-color:var(--gold);
  box-shadow:0 8px 32px rgba(0,0,0,0.5), 0 0 20px rgba(255,215,0,0.4);
}

.toast-icon {
  font-size:24px;
  flex-shrink:0;
}

.toast-content {
  flex:1;
}

.toast-title {
  font-family:'Rajdhani',sans-serif;
  font-size:14px;
  font-weight:700;
  text-transform:uppercase;
  letter-spacing:1px;
  color:var(--text);
  margin-bottom:2px;
}

.toast-message {
  font-family:'Inter',sans-serif;
  font-size:12px;
  color:var(--text-dim);
}

.toast.removing {
  animation:slideOutRight 0.3s ease-in forwards;
}

@keyframes slideInRight {
  from {
    transform:translateX(400px);
    opacity:0;
  }
  to {
    transform:translateX(0);
    opacity:1;
  }
}

@keyframes slideOutRight {
  from {
    transform:translateX(0);
    opacity:1;
  }
  to {
    transform:translateX(400px);
    opacity:0;
  }
}

@media (max-width: 640px) {
  .toast-container {
    left:20px;
    right:20px;
    align-items:stretch;
  }
  
  .toast {
    min-width:0;
  }
}

.progress{
  height:14px;
  background:var(--bg-elevated);
  border-radius:20px;
  overflow:hidden;
  position:relative;
  margin:16px 0 8px;
  border:1px solid var(--border);
}

.progress-fill{
  height:100%;
  background:linear-gradient(90deg, var(--accent), #6366f1);
  transition:width 0.3s ease;
  border-radius:20px;
}

.muted{color:var(--text-dim);margin:8px 0}

#why .muted {
  font-size:15px;
  color:var(--text);
  padding:8px 12px;
  margin:6px 0;
  border-left:3px solid var(--gold);
  background:linear-gradient(90deg, rgba(255,215,0,0.1) 0%, transparent 100%);
  border-radius:0 8px 8px 0;
  transition:all 0.3s;
}

#why .muted:hover {
  border-left-width:5px;
  background:linear-gradient(90deg, rgba(255,215,0,0.15) 0%, transparent 100%);
  transform:translateX(4px);
}

.grid{
  display:grid;
  grid-template-columns:2fr 80px 120px 2.5fr;
  gap:12px;
  align-items:start;
  padding:12px 0;
  text-align:left;
}

.grid > div {
  min-width:0;
}

.grid > div:first-child {
  word-wrap:break-word;
  overflow-wrap:break-word;
}

.grid > div:nth-child(2),
.grid > div:nth-child(3) {
  white-space:nowrap;
  text-align:center;
  font-weight:600;
}

.grid > div:nth-child(4) {
  word-wrap:break-word;
  overflow-wrap:break-word;
}

.gridHeader{
  font-weight:700;
  color:var(--accent);
  border-bottom:2px solid var(--accent);
  text-align:left;
  padding-bottom:8px;
  margin-bottom:8px;
}

.gridHeader > div:nth-child(2),
.gridHeader > div:nth-child(3) {
  text-align:center;
  font-weight:700;
}

.exercise-link{
  color:var(--text);
  text-decoration:none;
  cursor:pointer;
  transition:color 0.2s;
}

.exercise-link:hover{
  color:var(--accent);
  text-decoration:underline;
}

.note{
  width:100%;
  min-height:60px;
  margin-top:8px;
  font-family:'Inter',sans-serif;
  text-transform:none;
  letter-spacing:0;
}

.modal{
  display:none;
  position:fixed;
  top:0;left:0;right:0;bottom:0;
  background:rgba(0,0,0,0.85);
  z-index:1000;
  align-items:center;
  justify-content:center;
  padding:20px;
}

.modal-content{
  background:var(--bg-card);
  border:2px solid var(--accent);
  border-radius:20px;
  padding:32px;
  max-width:600px;
  max-height:90vh;
  overflow-y:auto;
  position:relative;
}

.modal-content h2{
  font-family:'Rajdhani',sans-serif;
  color:var(--accent);
  margin-bottom:24px;
  font-size:24px;
  text-transform:uppercase;
  letter-spacing:3px;
}

.modal-content h3{
  font-family:'Rajdhani',sans-serif;
  color:var(--text);
  margin:16px 0 8px;
  font-size:16px;
  text-transform:uppercase;
  letter-spacing:2px;
}

.modal-content ul{
  margin-left:20px;
  margin-bottom:16px;
}

.modal-content li{
  margin:6px 0;
  color:var(--text-dim);
}

.close-btn{
  position:absolute;
  top:16px;
  right:16px;
  background:none;
  border:none;
  color:var(--accent);
  font-size:32px;
  cursor:pointer;
  padding:0;
  width:40px;
  height:40px;
  display:flex;
  align-items:center;
  justify-content:center;
}

.close-btn:hover{
  transform:scale(1.1);
  color:var(--text);
}

.celebration-modal{
  display:none;
  position:fixed;
  top:0;left:0;right:0;bottom:0;
  background:rgba(0,0,0,0.95);
  z-index:2000;
  align-items:center;
  justify-content:center;
}

.celebration-content{
  position:relative;
  z-index:2001;
  text-align:center;
}

.celebration-text{
  font-family:'Rajdhani',sans-serif;
  font-size:48px;
  font-weight:700;
  text-transform:uppercase;
  letter-spacing:6px;
  margin-bottom:40px;
  animation:celebrationPulse 1s ease-in-out infinite;
}

.medal-display{
  font-size:120px;
  animation:medalBounce 0.6s ease-out;
}

#confettiCanvas{
  position:absolute;
  top:0;left:0;
  width:100%;
  height:100%;
  pointer-events:none;
  z-index:2000;
}

@keyframes celebrationPulse{
  0%, 100%{transform:scale(1);opacity:1;}
  50%{transform:scale(1.1);opacity:0.9;}
}

@keyframes medalBounce{
  0%{transform:scale(0) rotate(0deg);}
  50%{transform:scale(1.2) rotate(180deg);}
  100%{transform:scale(1) rotate(360deg);}
}

@keyframes shake{
  0%, 100%{transform:translateX(0);}
  10%, 30%, 50%, 70%, 90%{transform:translateX(-10px);}
  20%, 40%, 60%, 80%{transform:translateX(10px);}
}

.celebration-bronze{
  background:linear-gradient(135deg, #cd7f32 0%, #8B4513 100%);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
}

.celebration-silver{
  background:linear-gradient(135deg, #C0C0C0 0%, #808080 100%);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  animation:celebrationPulse 0.8s ease-in-out infinite;
}

.celebration-gold{
  background:linear-gradient(135deg, #FFD700 0%, #FFA500 50%, #FFD700 100%);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  animation:celebrationPulse 0.5s ease-in-out infinite, shake 0.5s ease-in-out infinite;
}

@media (max-width: 640px) {
  .grid {
    grid-template-columns:1.5fr 60px 100px 1.8fr;
    gap:8px;
    font-size:13px;
  }
  
  .grid > div:nth-child(2),
  .grid > div:nth-child(3) {
    font-size:12px;
  }
  
  .gridHeader {
    font-size:12px;
  }
  
  h1 {
    font-size:26px;
    letter-spacing:3px;
  }
  
  .controls-bar {
    gap:8px;
  }
  
  .player-info {
    flex-direction:column;
    gap:6px;
    align-items:center;
  }
}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="player-info">
      <span class="player-name" id="playerChip">Player</span>
      <span class="phase-badge" id="phaseLabel">Phase 1</span>
    </div>
    <h1>Sky Core</h1>
    <div class="controls-bar">
      <select id="daySel">
        <option value="1">Day 1 ‚Äî JUMP</option>
        <option value="2">Day 2 ‚Äî POWER</option>
        <option value="3">Day 3 ‚Äî STRENGTH</option>
      </select>
      <select id="week"></select>
      <button id="exportCsv">Export CSV</button>
    </div>
    <div class="xp-row">
      <span id="xp">XP 0</span>
      <div class="badges" id="badges"></div>
    </div>
    <div class="progress">
      <div class="progress-fill" id="xpbar"></div>
    </div>
  </header>
  <div class="card">
    <div class="payoff-header">
      <span class="payoff-icon">‚ö°</span>
      <strong class="payoff-title">The Payoff</strong>
      <span class="payoff-icon">‚ö°</span>
    </div>
    <div id="why"></div>
  </div>
  <div id="content"></div>
  <textarea id="notes" class="note" placeholder="Personal notes..."></textarea>
</div>

<div id="loadingScreen" class="loading-screen">
  <div class="loading-content">
    <div class="loading-logo">
      <svg width="80" height="80" viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg">
        <circle cx="40" cy="40" r="35" stroke="url(#grad1)" stroke-width="3" stroke-dasharray="220" stroke-dashoffset="220" class="loading-circle"/>
        <path d="M40 15 L50 35 L70 35 L55 48 L60 68 L40 55 L20 68 L25 48 L10 35 L30 35 Z" fill="url(#grad2)" class="loading-star"/>
        <defs>
          <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" style="stop-color:var(--accent);stop-opacity:1" />
            <stop offset="100%" style="stop-color:#6366f1;stop-opacity:1" />
          </linearGradient>
          <linearGradient id="grad2" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" style="stop-color:var(--gold);stop-opacity:1" />
            <stop offset="100%" style="stop-color:#ffed4e;stop-opacity:1" />
          </linearGradient>
        </defs>
      </svg>
    </div>
    <div class="loading-text">Sky Core</div>
    <div class="loading-subtext">Initializing...</div>
  </div>
</div>

<div id="toastContainer" class="toast-container"></div>

<div id="trainerModal" class="modal">
  <div class="modal-content">
    <button class="close-btn" id="mClose">√ó</button>
    <h2 id="mTitle">Exercise</h2>
    <h3>Setup</h3>
    <ul id="mSetup"></ul>
    <h3>Execution</h3>
    <ul id="mExec"></ul>
    <h3>Focus</h3>
    <ul id="mFocus"></ul>
    <h3>Common Mistakes</h3>
    <ul id="mMistakes"></ul>
    <h3>Why This Exercise</h3>
    <ul id="mWhy"></ul>
  </div>
</div>

<div id="celebrationModal" class="celebration-modal">
  <div class="celebration-content">
    <div id="celebrationText" class="celebration-text"></div>
    <div id="medalDisplay" class="medal-display"></div>
  </div>
  <canvas id="confettiCanvas"></canvas>
</div>

<script>
/* ----- Program ----- */
const PROGRAM={
  1:{
    day:"Day 1 ‚Äî JUMP",
    why:["Develop explosive power","Master vertical jump mechanics","Build reactive strength"],
    warmup:["Hip Circles ‚Äî 10 each","Leg Swings ‚Äî 10 each","Walking Lunges ‚Äî 10","Glute Bridges ‚Äî 15","Jump Rope ‚Äî 2 min"],
    strength:[
      {ex:"Trap/Barbell Deadlift",sets:4,reps:"6",weighted:true},
      {ex:"Front Squat",sets:3,reps:"8",weighted:true},
      {ex:"Hip Thrust or Glute Bridge",sets:3,reps:"12",weighted:true}
    ],
    core:["Plank Holds ‚Äî 3√ó45 sec","Dead Bug ‚Äî 3√ó10 each"],
    jump:["Two-step approach jumps ‚Äî 3√ó5","Form jumps ‚Äî 3√ó8","Touch rim/backboard ‚Äî 5 max"]
  },
  2:{
    day:"Day 2 ‚Äî POWER",
    why:["Build explosive speed-strength","Increase power output","Enhance athletic performance"],
    warmup:["Jumping Jacks ‚Äî 30","Arm Circles ‚Äî 10 each","High Knees ‚Äî 20","Butt Kicks ‚Äî 20","Bodyweight Squats ‚Äî 15"],
    strength:[
      {ex:"Hang Power Clean",sets:4,reps:"4",weighted:true},
      {ex:"Box Jumps",sets:4,reps:"5",weighted:false},
      {ex:"Bulgarian Split Squat",sets:3,reps:"8 each",weighted:true}
    ],
    core:["Russian Twists ‚Äî 3√ó20","Bicycle Crunches ‚Äî 3√ó20"],
    jump:["Standing Broad Jump ‚Äî 5√ó3","Approach & Plant Drill ‚Äî 4√ó5"]
  },
  3:{
    day:"Day 3 ‚Äî STRENGTH",
    why:["Build foundational strength","Increase muscle mass","Improve movement quality"],
    warmup:["Foam Roll ‚Äî 5 min","Cat-Cow ‚Äî 10","Bodyweight RDL ‚Äî 10","Band Pull-Aparts ‚Äî 15"],
    strength:[
      {ex:"Back Squat",sets:4,reps:"6",weighted:true},
      {ex:"Romanian Deadlift",sets:3,reps:"8",weighted:true},
      {ex:"Step-Ups",sets:3,reps:"10 each",weighted:true}
    ],
    core:["Side Plank ‚Äî 3√ó30 sec each","Hollow Hold ‚Äî 3√ó20 sec"],
    jump:["Form jumps ‚Äî 3√ó6","Dunk attempts ‚Äî 10 max effort"]
  }
};

/* ----- Exercise Database ----- */
const EX={
  "Hip Circles":{setup:["Stand on one leg"],exec:["Swing other leg in circles"],focus:["Control; full range"],mistakes:["Too fast"],why:["Hip mobility"]},
  "Leg Swings":{setup:["Hold wall/support"],exec:["Swing leg forward & back"],focus:["Straight leg; control"],mistakes:["Too aggressive"],why:["Dynamic flexibility"]},
  "Walking Lunges":{setup:["Stand tall"],exec:["Step & lower; alternate"],focus:["Knee alignment; upright torso"],mistakes:["Knee collapse"],why:["Single-leg strength & balance"]},
  "Glute Bridges":{setup:["Lie on back; feet flat"],exec:["Drive heels; lift hips"],focus:["Squeeze glutes at top"],mistakes:["Arching lower back"],why:["Glute activation"]},
  "Jump Rope":{setup:["Light grip; elbows in"],exec:["Small wrist rotation"],focus:["Bounce on balls of feet"],mistakes:["Too high jumps"],why:["Foot coordination & conditioning"]},
  "Jumping Jacks":{setup:["Stand with feet together"],exec:["Jump feet out, arms overhead; return"],focus:["Rhythm; full extension"],mistakes:["Partial range"],why:["Warm-up & coordination"]},
  "Arm Circles":{setup:["Arms extended sideways"],exec:["Make circles forward then back"],focus:["Full shoulder range"],mistakes:["Too small circles"],why:["Shoulder mobility"]},
  "High Knees":{setup:["Stand tall"],exec:["Drive knees up quickly"],focus:["Fast tempo; high knees"],mistakes:["Leaning back"],why:["Hip flexor activation"]},
  "Butt Kicks":{setup:["Stand tall"],exec:["Kick heels to glutes"],focus:["Quick tempo"],mistakes:["Slow movement"],why:["Hamstring activation"]},
  "Bodyweight Squats":{setup:["Feet shoulder-width"],exec:["Sit back & down; stand"],focus:["Knees track toes; chest up"],mistakes:["Knees caving"],why:["Movement prep"]},
  "Foam Roll":{setup:["Position body part on roller"],exec:["Roll slowly over muscle"],focus:["Pause on tight spots"],mistakes:["Rolling too fast"],why:["Release muscle tension"]},
  "Cat-Cow":{setup:["Hands & knees"],exec:["Arch spine (cow); round spine (cat)"],focus:["Full spinal motion"],mistakes:["No movement in hips"],why:["Spinal mobility"]},
  "Bodyweight RDL":{setup:["Stand; feet hip-width"],exec:["Hinge at hips; slight knee bend"],focus:["Flat back; hamstring stretch"],mistakes:["Rounding back"],why:["Hamstring & hip prep"]},
  "Band Pull-Aparts":{setup:["Hold band arms extended"],exec:["Pull apart to chest"],focus:["Squeeze shoulder blades"],mistakes:["Shrugging shoulders"],why:["Upper back activation"]},
  "Plank Holds":{setup:["Forearms & toes; straight line"],exec:["Hold position; breathe"],focus:["Neutral spine; no sagging"],mistakes:["Hips too high/low"],why:["Core stability"]},
  "Dead Bug":{setup:["Lie on back; arms up; knees bent"],exec:["Lower opposite arm & leg"],focus:["Keep lower back flat"],mistakes:["Back arching"],why:["Anti-extension core control"]},
  "Russian Twists":{setup:["Sit; lean back; feet up"],exec:["Rotate torso side to side"],focus:["Control; full rotation"],mistakes:["Just moving arms"],why:["Rotational core strength"]},
  "Bicycle Crunches":{setup:["Lie on back; hands at head"],exec:["Alternate knee to opposite elbow"],focus:["Full rotation; slow"],mistakes:["Pulling on neck"],why:["Oblique strength"]},
  "Side Plank":{setup:["One forearm & side of foot"],exec:["Hold straight line"],focus:["Stack hips; don't sag"],mistakes:["Hips dropping"],why:["Lateral core stability"]},
  "Hollow Hold":{setup:["Lie on back"],exec:["Lift shoulders & legs; hold"],focus:["Press low back down"],mistakes:["Arching back"],why:["Total core tension"]},
  "Hang Power Clean":{setup:["Hang position; bar at knees"],exec:["Explosive hip extension; catch at shoulders"],focus:["Triple extension; fast elbows"],mistakes:["Arms pulling early"],why:["Explosive power from hips"]},
  "Box Jumps":{setup:["Stand facing box"],exec:["Swing arms; jump onto box; land soft"],focus:["Full hip extension; quiet landing"],mistakes:["Stomping landing"],why:["Explosive leg power & landing control"]},
  "Bulgarian Split Squat":{setup:["Rear foot elevated on bench"],exec:["Lower into lunge; drive up"],focus:["Upright torso; front knee tracking"],mistakes:["Leaning forward"],why:["Single-leg strength & balance"]},
  "Standing Broad Jump":{setup:["Feet shoulder-width"],exec:["Load; swing arms; jump forward"],focus:["Distance; stick landing"],mistakes:["Not sticking landing"],why:["Horizontal power"]},
  "Approach & Plant Drill":{setup:["Short approach run-up"],exec:["Plant foot; load; pause"],focus:["Foot angle; quick load"],mistakes:["Slow plant"],why:["Jump takeoff timing"]},
  "Front Squat":{setup:["Bar on front delts; elbows high"],exec:["Descend; drive up through heels"],focus:["Upright torso; full depth"],mistakes:["Elbows dropping"],why:["Quad strength; upright posture"]},
  "Back Squat":{setup:["Bar on traps; feet shoulder-width"],exec:["Sit back & down; drive up"],focus:["Depth; knees out"],mistakes:["Good morning squat"],why:["Total leg strength"]},
  "Romanian Deadlift":{setup:["Bar at hips; slight knee bend"],exec:["Hinge at hips; lower bar to shins"],focus:["Flat back; hamstring stretch"],mistakes:["Rounding back"],why:["Hamstring & posterior chain"]},
  "Step-Ups":{setup:["One foot on box"],exec:["Drive through heel; step up"],focus:["Controlled; full extension"],mistakes:["Pushing off back foot"],why:["Unilateral leg strength"]},
  "Trap/Barbell Deadlift":{setup:["Feet hip; bar midfoot"],exec:["Brace; push floor; stand tall"],focus:["Neutral spine; bar close"],mistakes:["Rounding"],why:["Total-body force"]},
  "Hip Thrust or Glute Bridge":{setup:["Shoulders on bench/floor"],exec:["Drive heels; squeeze top"],focus:["Posterior tilt"],mistakes:["Short range"],why:["Direct hip extension power"]},
  "Two-step approach jumps":{setup:["Short two-step run-up"],exec:["Quick plant; load; full arm swing; explode"],focus:["Plant timing","Fast transition"],mistakes:["Choppy steps"],why:["Game rhythm & elastic timing"]},
  "Form jumps":{setup:["Feet under shoulders"],exec:["Jump straight; land soft; reset"],focus:["Quiet feet","Knees track"],mistakes:["Stomping"],why:["Pattern & landing control"]},
  "Touch rim/backboard":{setup:["Same approach each rep"],exec:["Reach tall; stick landing"],focus:["Consistency","Full extension"],mistakes:["Changing rhythm"],why:["Measurable peak reach timing"]},
  "Dunk attempts":{setup:["Same approach each rep"],exec:["Commit to takeoff"],focus:["Confidence; timing"],mistakes:["Indecision"],why:["Skill on top of power"]}
};

/* ----- Celebration System ----- */
let audioContext = null;

function initAudio() {
  if (!audioContext) {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
  }
}

function playTone(frequency, duration, type = 'sine', volume = 0.3, startTime = 0) {
  initAudio();
  const oscillator = audioContext.createOscillator();
  const gainNode = audioContext.createGain();
  
  oscillator.connect(gainNode);
  gainNode.connect(audioContext.destination);
  
  oscillator.frequency.value = frequency;
  oscillator.type = type;
  gainNode.gain.setValueAtTime(volume, audioContext.currentTime + startTime);
  
  oscillator.start(audioContext.currentTime + startTime);
  gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + startTime + duration);
  oscillator.stop(audioContext.currentTime + startTime + duration);
}

function createKick(startTime = 0) {
  initAudio();
  const osc = audioContext.createOscillator();
  const gain = audioContext.createGain();
  
  osc.connect(gain);
  gain.connect(audioContext.destination);
  
  osc.frequency.setValueAtTime(150, audioContext.currentTime + startTime);
  osc.frequency.exponentialRampToValueAtTime(0.01, audioContext.currentTime + startTime + 0.5);
  
  gain.gain.setValueAtTime(1, audioContext.currentTime + startTime);
  gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + startTime + 0.5);
  
  osc.start(audioContext.currentTime + startTime);
  osc.stop(audioContext.currentTime + startTime + 0.5);
}

function createSnare(startTime = 0) {
  initAudio();
  const noise = audioContext.createBufferSource();
  const buffer = audioContext.createBuffer(1, audioContext.sampleRate * 0.2, audioContext.sampleRate);
  const data = buffer.getChannelData(0);
  
  for (let i = 0; i < buffer.length; i++) {
    data[i] = Math.random() * 2 - 1;
  }
  
  noise.buffer = buffer;
  
  const noiseGain = audioContext.createGain();
  noise.connect(noiseGain);
  noiseGain.connect(audioContext.destination);
  
  noiseGain.gain.setValueAtTime(0.3, audioContext.currentTime + startTime);
  noiseGain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + startTime + 0.2);
  
  noise.start(audioContext.currentTime + startTime);
}

function createRiser(duration, startTime = 0) {
  initAudio();
  const osc = audioContext.createOscillator();
  const gain = audioContext.createGain();
  
  osc.type = 'sawtooth';
  osc.connect(gain);
  gain.connect(audioContext.destination);
  
  osc.frequency.setValueAtTime(100, audioContext.currentTime + startTime);
  osc.frequency.exponentialRampToValueAtTime(1000, audioContext.currentTime + startTime + duration);
  
  gain.gain.setValueAtTime(0.1, audioContext.currentTime + startTime);
  gain.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + startTime + duration);
  
  osc.start(audioContext.currentTime + startTime);
  osc.stop(audioContext.currentTime + startTime + duration);
}

function playBronzeSound() {
  // Achievement unlocked style
  initAudio();
  
  playTone(1046.50, 0.6, 'sine', 0.4, 0);
  playTone(1318.51, 0.6, 'sine', 0.3, 0.1);
  playTone(523.25, 0.8, 'triangle', 0.2, 0);
  createKick(0);
  playTone(2093.00, 0.3, 'sine', 0.15, 0.3);
}

function playSilverSound() {
  // Power-up with bass drop
  initAudio();
  
  createRiser(0.4, 0);
  playTone(523.25, 0.15, 'square', 0.3, 0.4);
  playTone(659.25, 0.15, 'square', 0.3, 0.5);
  playTone(783.99, 0.15, 'square', 0.3, 0.6);
  playTone(1046.50, 0.2, 'square', 0.35, 0.7);
  playTone(1318.51, 0.3, 'sine', 0.4, 0.9);
  
  createKick(0.4);
  createKick(0.7);
  createKick(1.0);
  
  createSnare(0.55);
  createSnare(0.85);
  
  playTone(2093.00, 0.2, 'sine', 0.2, 0.9);
  playTone(2637.02, 0.3, 'sine', 0.2, 1.1);
}

function playGoldSound() {
  // Epic victory
  initAudio();
  
  createRiser(0.6, 0);
  
  createKick(0.6);
  createKick(0.8);
  createKick(1.0);
  createKick(1.2);
  
  const melody = [
    {f: 523.25, t: 0.6, d: 0.15},
    {f: 659.25, t: 0.75, d: 0.15},
    {f: 783.99, t: 0.9, d: 0.15},
    {f: 1046.50, t: 1.05, d: 0.2},
    {f: 1318.51, t: 1.25, d: 0.25},
    {f: 1567.98, t: 1.5, d: 0.3},
    {f: 2093.00, t: 1.8, d: 0.5}
  ];
  
  melody.forEach(note => {
    playTone(note.f, note.d, 'square', 0.35, note.t);
    playTone(note.f * 1.5, note.d, 'triangle', 0.2, note.t);
    playTone(note.f / 2, note.d, 'sawtooth', 0.25, note.t);
  });
  
  createSnare(0.7);
  createSnare(0.8);
  createSnare(0.95);
  createSnare(1.1);
  createSnare(1.3);
  createSnare(1.5);
  createSnare(1.7);
  
  for(let i = 0; i < 8; i++) {
    playTone(2093.00 + (i * 200), 0.2, 'sine', 0.15, 0.6 + (i * 0.15));
  }
  
  createKick(2.3);
  playTone(130.81, 0.8, 'sawtooth', 0.4, 2.3);
  
  playTone(2093.00, 0.5, 'sine', 0.3, 2.5);
  playTone(2637.02, 0.5, 'sine', 0.3, 2.6);
  playTone(3135.96, 0.6, 'sine', 0.35, 2.7);
}

class Confetti {
  constructor(canvas, color, count) {
    this.canvas = canvas;
    this.ctx = canvas.getContext('2d');
    this.particles = [];
    this.count = count;
    this.colors = color;
  }

  init() {
    this.canvas.width = window.innerWidth;
    this.canvas.height = window.innerHeight;
    
    for (let i = 0; i < this.count; i++) {
      this.particles.push({
        x: Math.random() * this.canvas.width,
        y: -10 - Math.random() * 100,
        size: Math.random() * 8 + 4,
        speedY: Math.random() * 3 + 2,
        speedX: (Math.random() - 0.5) * 4,
        color: this.colors[Math.floor(Math.random() * this.colors.length)],
        rotation: Math.random() * 360,
        rotationSpeed: (Math.random() - 0.5) * 10
      });
    }
  }

  update() {
    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
    
    this.particles.forEach((p, index) => {
      p.y += p.speedY;
      p.x += p.speedX;
      p.rotation += p.rotationSpeed;
      p.speedY += 0.1; // gravity
      
      this.ctx.save();
      this.ctx.translate(p.x, p.y);
      this.ctx.rotate((p.rotation * Math.PI) / 180);
      
      // Add glow effect
      this.ctx.shadowBlur = 10;
      this.ctx.shadowColor = p.color;
      this.ctx.fillStyle = p.color;
      this.ctx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size);
      this.ctx.restore();
      
      if (p.y > this.canvas.height + 10) {
        this.particles.splice(index, 1);
      }
    });
    
    if (this.particles.length > 0) {
      requestAnimationFrame(() => this.update());
    }
  }
}

function celebrate(medalType, week) {
  initAudio();
  
  const modal = document.getElementById('celebrationModal');
  const textEl = document.getElementById('celebrationText');
  const medalEl = document.getElementById('medalDisplay');
  const canvas = document.getElementById('confettiCanvas');
  
  let colors, count, sound, emoji, title;
  
  switch(medalType) {
    case 'bronze':
      colors = ['#CD7F32', '#8B4513', '#D2691E'];
      count = 50;
      sound = playBronzeSound;
      emoji = 'ü•â';
      title = 'Bronze Medal!';
      textEl.className = 'celebration-text celebration-bronze';
      break;
    case 'silver':
      colors = ['#C0C0C0', '#A9A9A9', '#D3D3D3', '#808080'];
      count = 100;
      sound = playSilverSound;
      emoji = 'ü•à';
      title = 'Silver Medal!';
      textEl.className = 'celebration-text celebration-silver';
      break;
    case 'gold':
      colors = ['#FFD700', '#FFA500', '#FFFF00', '#FF8C00', '#FFB90F'];
      count = 200;
      sound = playGoldSound;
      emoji = 'ü•á';
      title = 'Gold Medal!';
      textEl.className = 'celebration-text celebration-gold';
      break;
  }
  
  textEl.innerHTML = `${title}<br><span style="font-size:24px;letter-spacing:2px;">Week ${week} Workout Complete!</span>`;
  medalEl.textContent = emoji;
  
  modal.style.display = 'flex';
  
  // Play sound
  sound();
  
  // Start confetti
  const confetti = new Confetti(canvas, colors, count);
  confetti.init();
  confetti.update();
  
  // Auto close after duration based on medal type
  const duration = medalType === 'bronze' ? 2500 : medalType === 'silver' ? 3500 : 5000;
  setTimeout(() => {
    modal.style.display = 'none';
  }, duration);
}

/* ----- Weeks/UI/logic ----- */
const WEEKS=12;
const listKey="osc_players";
const key=(p,d,w)=>`osc_p${p}_d${d}_w${w}`;
const settingsKey=(p)=>`osc_settings_${p}`;
const xpKey=(p)=>`osc_xp_${p}`;
const streakKey=(p)=>`osc_streak_${p}`;
const lastKey=(p)=>`osc_last_${p}`;
const earnedKey=(p)=>`osc_earned_${p}`;
const boundPlayerKey='osc_bound_player';

const daySel=document.getElementById('daySel');
const weekSel=document.getElementById('week');
const whyDiv=document.getElementById('why');
const content=document.getElementById('content');
const notes=document.getElementById('notes');
const xpEl=document.getElementById('xp');
const exportBtn=document.getElementById('exportCsv');
const xpbar=document.getElementById('xpbar');
const badges=document.getElementById('badges');
const playerChip=document.getElementById('playerChip');

function loadSettings(p){ return JSON.parse(localStorage.getItem(settingsKey(p))||'{"school":"CORE Butte High","mascot":"Lynx","colors":"Blue & White","coachUrl":""}'); }
function saveSettings(p,s){ localStorage.setItem(settingsKey(p), JSON.stringify(s)); }
function loadEntry(p,d,w){ const raw=localStorage.getItem(key(p,d,w)); return raw?JSON.parse(raw):null; }
function saveEntry(p,d,w,val){ 
  localStorage.setItem(key(p,d,w), JSON.stringify(val));
  // fire-and-forget sync on every save
  sendCoachSnapshotDebounced();
}
function getXP(p){ return +(localStorage.getItem(xpKey(p))||0); }
function setXP(p,v){ localStorage.setItem(xpKey(p), v); }
function getStreak(p){ return +(localStorage.getItem(streakKey(p))||0); }
function setStreak(p,v){ localStorage.setItem(streakKey(p), v); }
function getLast(p){ return localStorage.getItem(lastKey(p)); }
function setLast(p,day){ localStorage.setItem(lastKey(p), day); }
function loadEarned(p){ return JSON.parse(localStorage.getItem(earnedKey(p))||'{}'); }
function saveEarned(p,m){ localStorage.setItem(earnedKey(p), JSON.stringify(m)); }

function currentPlayer(){ return localStorage.getItem(boundPlayerKey) || null; }
function promptForNameOnce(){
  let nm = localStorage.getItem(boundPlayerKey);
  if(nm) return nm;
  while(!nm){
    nm = (prompt("Enter your name to set up your app")||"").trim();
    if(!nm) alert("Name is required.");
  }
  localStorage.setItem(boundPlayerKey,nm);
  return nm;
}

function updateXPView(p){ 
  const x=getXP(p); 
  xpEl.textContent="XP "+x; 
  const pct=Math.min(100,(x%100)); 
  // Note: xpbar width is set by completion percentage in render, not XP
}

function awardXPOnce(p,id,amt){ 
  const m=loadEarned(p); 
  if(m[id]) return; 
  m[id]=amt; 
  saveEarned(p,m); 
  setXP(p,getXP(p)+amt); 
  updateXPView(p); 
}

function updateStreak(p){
  const today = new Date().toDateString();
  const last = getLast(p);
  
  if(last === today){
    // Already counted today
    streakEl.textContent = `üî• ${getStreak(p)}`;
    return;
  }
  
  const yesterday = new Date();
  yesterday.setDate(yesterday.getDate() - 1);
  const yesterdayStr = yesterday.toDateString();
  
  if(last === yesterdayStr){
    // Continue streak
    setStreak(p, getStreak(p) + 1);
  } else if(!last || last !== today){
    // Start new streak
    setStreak(p, 1);
  }
  
  setLast(p, today);
  streakEl.textContent = `üî• ${getStreak(p)}`;
}

function sendCoachSnapshot(){
  // Load config
  fetch('./config.json')
    .then(r => r.json())
    .then(cfg => {
      const coachUrl = cfg.coachSyncUrl || cfg.coachUrl;
      if(!coachUrl) return;
      
      const p = currentPlayer();
      if(!p) return;
      
      // Gather all data for this player
      const snapshot = {
        player: p,
        xp: getXP(p),
        timestamp: new Date().toISOString(),
        weeks: []
      };
      
      // Collect all week/day data
      for(let w = 1; w <= WEEKS; w++){
        for(let d = 1; d <= 3; d++){
          const entry = loadEntry(p, d, w);
          if(entry){
            snapshot.weeks.push({
              week: w,
              day: d,
              data: entry
            });
          }
        }
      }
      
      // Send to coach
      fetch(coachUrl, {
        method: 'POST',
        mode: 'no-cors',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(snapshot)
      }).catch(err => console.log('Sync error (ignored):', err));
    })
    .catch(err => console.log('Config load error:', err));
}

function debounce(fn, ms){ 
  let t; 
  return (...a)=>{ 
    clearTimeout(t); 
    t=setTimeout(()=>fn(...a), ms); 
  }; 
}

const sendCoachSnapshotDebounced = debounce(sendCoachSnapshot, 350);

function init(day){ 
  return {
    warmup: PROGRAM[day].warmup.map(()=>false),
    strength: PROGRAM[day].strength.map(b=>({
      weight:"",
      notes:"",
      sets:Array.from({length:b.sets},()=>({done:false}))
    })),
    core: PROGRAM[day].core.map(()=>false),
    jump: PROGRAM[day].jump.map(()=>false),
    notes:""
  }; 
}

function openTrainer(name){
  const base = name.split(' ‚Äî ')[0];
  const d=EX[base]; if(!d) return;
  function fill(arr,id){ 
    const el=document.getElementById(id); 
    el.innerHTML=""; 
    (arr||[]).forEach(t=>{ 
      const li=document.createElement('li'); 
      li.textContent=t; 
      el.appendChild(li); 
    });
  }
  document.getElementById('mTitle').textContent=base; 
  fill(d.setup,'mSetup'); 
  fill(d.exec,'mExec'); 
  fill(d.focus,'mFocus'); 
  fill(d.mistakes,'mMistakes'); 
  fill(d.why,'mWhy');
  document.getElementById('trainerModal').style.display='flex';
}

document.getElementById('mClose').onclick=()=>document.getElementById('trainerModal').style.display='none';
document.getElementById('trainerModal').onclick=(e)=>{ 
  if(e.target.id==='trainerModal') document.getElementById('trainerModal').style.display='none'; 
};

// Close celebration modal on click
document.getElementById('celebrationModal').onclick=()=>{
  document.getElementById('celebrationModal').style.display='none';
};

exportBtn.onclick=()=>{ 
  const p=currentPlayer(),d=+daySel.value,w=+weekSel.value; 
  const e=loadEntry(p,d,w)||init(d); 
  const rows=[["Player","Week","Day","Section","Item","Set","Done","Weight","Notes","XP"]];
  
  e.warmup.forEach((ck,i)=>rows.push([p,w,d,"Warmup",PROGRAM[d].warmup[i],"",ck?"yes":"","","",getXP(p)]));
  e.strength.forEach((blk,i)=>{ 
    const ex=PROGRAM[d].strength[i].ex; 
    blk.sets.forEach((st,si)=>rows.push([p,w,d,"Strength",ex,si+1,st.done?"yes":"",blk.weight||"",blk.notes||"",getXP(p)])); 
  });
  e.core.forEach((ck,i)=>rows.push([p,w,d,"Core",PROGRAM[d].core[i],"",ck?"yes":"","","",getXP(p)]));
  e.jump.forEach((ck,i)=>rows.push([p,w,d,"Jump",PROGRAM[d].jump[i],"",ck?"yes":"","","",getXP(p)]));
  
  const csv=rows.map(r=>r.map(x=>`"${(x??"").toString().replace(/"/g,'""')}"`).join(",")).join("\n"); 
  const a=document.createElement('a'); 
  a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"})); 
  a.download=`OSC_${p}_w${w}_d${d}.csv`; 
  a.click(); 
};

function updatePhaseLabel(){ 
  const w=+weekSel.value||1; 
  document.getElementById('phaseLabel').textContent=(w<=6)?'Phase 1':'Phase 2'; 
}

function totalBoxes(d){ 
  let t=0; 
  t+=PROGRAM[d].warmup.length+PROGRAM[d].core.length+PROGRAM[d].jump.length; 
  PROGRAM[d].strength.forEach(blk=>t+=blk.sets); 
  return t; 
}

function currentDone(data,d){ 
  let c=0; 
  
  // Count warmup
  if(data.warmup) {
    data.warmup.forEach(x=>{if(x)c++;});
  }
  
  // Count core
  if(data.core) {
    data.core.forEach(x=>{if(x)c++;});
  }
  
  // Count jump
  if(data.jump) {
    data.jump.forEach(x=>{if(x)c++;});
  }
  
  // Count strength sets - with safety checks
  if(data.strength && PROGRAM[d] && PROGRAM[d].strength) {
    PROGRAM[d].strength.forEach((blk,i)=>{
      if(data.strength[i] && data.strength[i].sets) {
        data.strength[i].sets.forEach(s=>{
          if(s && s.done) c++;
        });
      }
    });
  }
  
  return c; 
}

function updateBadges(p, w){
  badges.innerHTML="";
  
  // Count how many days are complete for this week
  let completedDays = 0;
  for(let day = 1; day <= 3; day++) {
    const dayData = loadEntry(p, day, w) || init(day);
    const dayTotal = totalBoxes(day);
    const dayDone = currentDone(dayData, day);
    if(dayDone === dayTotal && dayTotal > 0) {
      completedDays++;
    }
  }
  
  // Award medals based on total completed days (any order)
  const medals = [
    {name: "Bronze", earned: completedDays >= 1},
    {name: "Silver", earned: completedDays >= 2},
    {name: "Gold", earned: completedDays >= 3}
  ];
  
  medals.forEach(medal => {
    const b = document.createElement('span');
    b.className = 'badge';
    
    if(medal.earned) {
      b.classList.add('earned');
      b.textContent = medal.name + " ‚úì";
    } else {
      b.textContent = medal.name;
    }
    
    badges.appendChild(b);
  });
}

function checkCelebration(p, d, w, wasDoneBefore, isDoneNow) {
  if (!wasDoneBefore && isDoneNow) {
    // Day just completed! Now check how many total days are complete for this week
    let completedDays = 0;
    for(let day = 1; day <= 3; day++) {
      const dayData = loadEntry(p, day, w) || init(day);
      const dayTotal = totalBoxes(day);
      const dayDone = currentDone(dayData, day);
      if(dayDone === dayTotal && dayTotal > 0) {
        completedDays++;
      }
    }
    
    // Award medal based on how many days are complete (not which day number)
    let medalType = '';
    if(completedDays === 1) {
      medalType = 'bronze';
    } else if(completedDays === 2) {
      medalType = 'silver';
    } else if(completedDays === 3) {
      medalType = 'gold';
    }
    
    if(medalType) {
      celebrate(medalType, w);
    }
  }
}

function render(){
  updatePhaseLabel();
  const p=currentPlayer(); 
  const d=+daySel.value; 
  const w=+weekSel.value||1;
  playerChip.textContent = p || "Player";
  
  const data=loadEntry(p,d,w)||init(d);
  
  // Check day completion for medals
  const total=totalBoxes(d); 
  const done=currentDone(data,d);
  const dayComplete = (done === total && total > 0);
  
  // Debug logging for current day
  console.log(`Current Day ${d}: ${done}/${total} complete (${Math.round(100*done/total)}%)`);
  
  updateBadges(p, w);
  
  updateXPView(p);
  
  whyDiv.innerHTML=PROGRAM[d].why.map(t=>"<div class='muted'>‚ñ∏ "+t+"</div>").join("");
  xpbar.style.width=(100*done/total)+"%";
  
  content.innerHTML="";
  
  // Warm-Up
  const warm=document.createElement('div'); 
  warm.className="card"; 
  warm.innerHTML="<strong>Warm-Up</strong>";
  PROGRAM[d].warmup.forEach((it,idx)=>{ 
    const row=document.createElement('div'); 
    row.className="row";
    const id=`wu_${d}_${idx}`; 
    const cb=document.createElement('input'); 
    cb.type="checkbox"; 
    cb.checked=data.warmup[idx];
    cb.onchange=()=>{ 
      const total = totalBoxes(d);
      const wasDoneBefore = currentDone(data, d) === total;
      
      data.warmup[idx]=cb.checked; 
      saveEntry(p,d,w,data); 
      if(cb.checked){ 
        awardXPOnce(p,id,5);
      }
      
      const isDoneNow = currentDone(data, d) === total;
      xpbar.style.width=(100*currentDone(data,d)/total)+"%";
      updateBadges(p,w);
      
      checkCelebration(p, d, w, wasDoneBefore, isDoneNow);
    };
    const link=document.createElement('span'); 
    link.className="exercise-link"; 
    link.textContent=it; 
    link.onclick=()=>openTrainer(it);
    row.appendChild(cb); 
    row.appendChild(link); 
    warm.appendChild(row);
  });
  content.appendChild(warm);

  // Strength
  const str=document.createElement('div'); 
  str.className="card"; 
  str.innerHTML="<strong>Strength</strong><div class='grid gridHeader'><div>Exercise</div><div>Sets</div><div>Reps</div><div>Weight / Notes</div></div>";
  PROGRAM[d].strength.forEach((blk,bi)=>{ 
    const g=document.createElement('div'); 
    g.className="grid";
    const link=document.createElement('span'); 
    link.className="exercise-link"; 
    link.textContent=blk.ex; 
    link.onclick=()=>openTrainer(blk.ex);
    const c1=document.createElement('div'); 
    c1.appendChild(link); 
    g.appendChild(c1);
    const c2=document.createElement('div'); 
    c2.textContent=blk.sets; 
    g.appendChild(c2);
    const c3=document.createElement('div'); 
    c3.textContent=blk.reps; 
    g.appendChild(c3);
    const c4=document.createElement('div');
    if(blk.weighted){ 
      const winput=document.createElement('input'); 
      winput.placeholder="lb"; 
      winput.style.width="100%"; 
      winput.value=(data.strength[bi].weight||""); 
      winput.oninput=()=>{ 
        data.strength[bi].weight=winput.value; 
        saveEntry(p,d,w,data); 
      }; 
      c4.appendChild(winput); 
    }
    const tarea=document.createElement('textarea'); 
    tarea.className="note"; 
    tarea.placeholder="Notes"; 
    tarea.value=(data.strength[bi].notes||""); 
    tarea.oninput=()=>{ 
      data.strength[bi].notes=tarea.value; 
      saveEntry(p,d,w,data); 
    }; 
    c4.appendChild(tarea);
    g.appendChild(c4); 
    str.appendChild(g);
    
    const setRow=document.createElement('div'); 
    setRow.className="row"; 
    setRow.style.marginTop="6px";
    setRow.style.paddingBottom="12px";
    setRow.style.borderBottom="1px solid var(--accent)";
    for(let s=0;s<blk.sets;s++){ 
      const lb=document.createElement('label'); 
      lb.className="row"; 
      const cb=document.createElement('input'); 
      cb.type="checkbox"; 
      cb.checked=data.strength[bi].sets[s].done; 
      const id=`st_${d}_${bi}_${s}`;
      cb.onchange=()=>{ 
        const total = totalBoxes(d);
        const wasDoneBefore = currentDone(data, d) === total;
        
        data.strength[bi].sets[s].done=cb.checked; 
        saveEntry(p,d,w,data); 
        if(cb.checked) awardXPOnce(p,id,10);
        
        const isDoneNow = currentDone(data, d) === total;
        xpbar.style.width=(100*currentDone(data,d)/total)+"%";
        updateBadges(p,w);
        
        checkCelebration(p, d, w, wasDoneBefore, isDoneNow);
      };
      lb.appendChild(cb); 
      lb.append(" Set "+(s+1)); 
      setRow.appendChild(lb);
    }
    str.appendChild(setRow);
  });
  content.appendChild(str);

  // Core
  const core=document.createElement('div'); 
  core.className="card"; 
  core.innerHTML="<strong>Core</strong>";
  PROGRAM[d].core.forEach((it,idx)=>{ 
    const row=document.createElement('div'); 
    row.className="row"; 
    const id=`co_${d}_${idx}`; 
    const cb=document.createElement('input'); 
    cb.type="checkbox"; 
    cb.checked=data.core[idx];
    cb.onchange=()=>{ 
      const total = totalBoxes(d);
      const wasDoneBefore = currentDone(data, d) === total;
      
      data.core[idx]=cb.checked; 
      saveEntry(p,d,w,data); 
      if(cb.checked) awardXPOnce(p,id,5);
      
      const isDoneNow = currentDone(data, d) === total;
      xpbar.style.width=(100*currentDone(data,d)/total)+"%";
      updateBadges(p,w);
      
      checkCelebration(p, d, w, wasDoneBefore, isDoneNow);
    };
    const link=document.createElement('span'); 
    link.className="exercise-link"; 
    link.textContent=it; 
    link.onclick=()=>openTrainer(it);
    row.appendChild(cb); 
    row.appendChild(link); 
    core.appendChild(row);
  });
  content.appendChild(core);

  // Jump Mechanics
  const jump=document.createElement('div'); 
  jump.className="card"; 
  jump.innerHTML="<strong>Jump Mechanics</strong>";
  PROGRAM[d].jump.forEach((it,idx)=>{ 
    const row=document.createElement('div'); 
    row.className="row"; 
    const id=`jm_${d}_${idx}`; 
    const cb=document.createElement('input'); 
    cb.type="checkbox"; 
    cb.checked=data.jump[idx];
    cb.onchange=()=>{ 
      const total = totalBoxes(d);
      const wasDoneBefore = currentDone(data, d) === total;
      
      data.jump[idx]=cb.checked; 
      saveEntry(p,d,w,data); 
      if(cb.checked) awardXPOnce(p,id,8);
      
      const isDoneNow = currentDone(data, d) === total;
      xpbar.style.width=(100*currentDone(data,d)/total)+"%";
      updateBadges(p,w);
      
      checkCelebration(p, d, w, wasDoneBefore, isDoneNow);
    };
    const link=document.createElement('span'); 
    link.className="exercise-link"; 
    link.textContent=it; 
    link.onclick=()=>openTrainer(it);
    row.appendChild(cb); 
    row.appendChild(link); 
    jump.appendChild(row);
  });
  content.appendChild(jump);

  notes.value=(data.notes||""); 
  notes.oninput=()=>{ 
    data.notes=notes.value; 
    saveEntry(p,d,w,data); 
  };
}

// Initialize
for(let w=1; w<=WEEKS; w++){ 
  const o=document.createElement('option'); 
  o.value=w; 
  o.textContent="Week "+w; 
  weekSel.appendChild(o); 
}

daySel.onchange=()=>{
  render();
  // Force update after render
  const p=currentPlayer(); 
  const d=+daySel.value; 
  const w=+weekSel.value||1;
  const data=loadEntry(p,d,w)||init(d);
  const total=totalBoxes(d); 
  const done=currentDone(data,d);
  xpbar.style.width=(100*done/total)+"%";
  updateBadges(p,w);
};

weekSel.onchange=()=>{
  render();
  // Force update after render
  const p=currentPlayer(); 
  const d=+daySel.value; 
  const w=+weekSel.value||1;
  const data=loadEntry(p,d,w)||init(d);
  const total=totalBoxes(d); 
  const done=currentDone(data,d);
  xpbar.style.width=(100*done/total)+"%";
  updateBadges(p,w);
};

// Register service worker
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('./sw.js')
    .then(()=>console.log('Service Worker registered'))
    .catch(err=>console.log('Service Worker registration failed:', err));
}

// First run
(function firstRun(){
  let p=currentPlayer();
  if(!p){ p = promptForNameOnce(); }
  playerChip.textContent = p;
  render();
  
  // Hide loading screen after app initializes
  setTimeout(() => {
    const loadingScreen = document.getElementById('loadingScreen');
    if(loadingScreen) {
      loadingScreen.classList.add('hidden');
      setTimeout(() => loadingScreen.remove(), 500);
    }
  }, 800);
})();

// Add haptic feedback for checkboxes (if supported)
document.addEventListener('change', (e) => {
  if(e.target.type === 'checkbox' && 'vibrate' in navigator) {
    navigator.vibrate(10); // Short haptic feedback
  }
});

// Toast notification system
function showToast(title, message, type = 'success', duration = 3000) {
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  
  const iconMap = {
    success: '‚úì',
    xp: '‚≠ê',
    'xp-gained': 'üí™'
  };
  
  toast.innerHTML = `
    <div class="toast-icon">${iconMap[type] || iconMap.success}</div>
    <div class="toast-content">
      <div class="toast-title">${title}</div>
      <div class="toast-message">${message}</div>
    </div>
  `;
  
  container.appendChild(toast);
  
  setTimeout(() => {
    toast.classList.add('removing');
    setTimeout(() => toast.remove(), 300);
  }, duration);
}

// Add subtle sound effects on completion
function playSuccessSound() {
  if(!audioContext) initAudio();
  playTone(523.25, 0.1, 'sine', 0.2, 0);
  playTone(659.25, 0.1, 'sine', 0.2, 0.1);
  playTone(783.99, 0.15, 'sine', 0.3, 0.2);
}

// Enhanced XP award function with toast notification
const originalAwardXPOnce = awardXPOnce;
awardXPOnce = function(p, id, amt) {
  const hadXP = getXP(p);
  originalAwardXPOnce(p, id, amt);
  const newXP = getXP(p);
  if(newXP > hadXP) {
    showToast('XP Gained!', `+${amt} XP`, 'xp-gained', 2000);
  }
};

// Trigger success sound when day is completed
const originalCheckCelebration = checkCelebration;
checkCelebration = function(p, d, w, wasDoneBefore, isDoneNow) {
  if (!wasDoneBefore && isDoneNow) {
    playSuccessSound();
    showToast('Day Complete!', 'Great work! Keep it up!', 'success', 4000);
  }
  originalCheckCelebration(p, d, w, wasDoneBefore, isDoneNow);
};
</script>
</body></html>
